@model Northwind.EF.MVC.Models.OrderDetailViewPaginated

@{
    ViewBag.Title = "Orders Details List";
}

<div>
    <h2>@ViewBag.Title</h2>
    <hr />
    <div class="alert alert-success success-message" role="alert" hidden></div>
    <div class="alert alert-danger failure-message" role="alert" hidden></div>
    <table class="table table-hover">
        <thead>
            <tr class="bg-primary">
                <th scope="col">ID</th>
                <th scope="col">Unit Price</th>
                <th scope="col">Discount</th>
                <th scope="col">Quantity</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model.PaginatedOrders())
            {
                <tr id="order-@order.Id-@order.PrdId">
                    <td scope="row">@order.Id</td>
                    <td>@order.UnitPrice</td>
                    <td>@order.Discount</td>
                    <td>@order.Quantity</td>

                    <td>
                        @Html.ActionLink("Edit", "Update", new { ordId = order.Id, prdId = order.PrdId }) |
                        <a href="#"
                           data-ordId="@order.Id"
                           data-prdId="@order.PrdId"
                           data-toggle="modal"
                           data-target="#modal-delete-order">
                            Delete
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <ul class="pagination ">
        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
            <a class="page-link"
               href="@(Model.CurrentPage > 1 ? Url.Action("Index", new { page = Model.CurrentPage - 1 }) : "#")">
                Prev
            </a>
        </li>

        @for (int i = Model.CurrentPage; i <= (Model.CurrentPage + 4 < Model.PageCount() ? Model.CurrentPage + 4 : Model.PageCount()); i++)
        {
            <li class="@(i == Model.CurrentPage ? "page-item active" : "page-item")">
                <a class="page-link" href="@Url.Action("Index", new { page = i })">@i</a>
            </li>
        }
        <li class="page-item @(Model.CurrentPage == Model.PageCount() ? "disabled" : "")">
            <a class="page-link" 
               href="@(Model.CurrentPage < Model.PageCount() ? Url.Action("Index", new { page = Model.CurrentPage + 5 }) : "#")">
                Next
            </a>
        </li>
    </ul>
    @Html.Partial("Delete")
</div>

@section scripts{
    <script type="text/javascript">
        $('.pagination .disabled').on('click', function (event) {
            event.preventDefault();
        });
        $('#modal-delete-order').on('show.bs.modal', function (event) {
            console.log(event.relatedTarget.dataset);
            var ordId = event.relatedTarget.dataset['ordid'];
            var prdId = event.relatedTarget.dataset['prdid'];
            $(this).find('.order-id').text(ordId);
            $(this).find('.product-id').text(prdId);
        });

        $('#modal-delete-order .btn-delete-order').on('click', function (event) {
            var ordId = $('.order-id').text();
            var prdId = $('.product-id').text();
            $.ajax({
                method: 'POST',
                url: `@Url.Action("Delete")/?ordId=${ordId}&prdId=${prdId}`,
            }).done(function (success) {
                $('.success-message').text(success.message)
                $('.success-message').show().delay(10000).fadeOut();
                $(`#order-${ordId}-${prdId}`).remove();
            }).fail(function (error) {
                $('.failure-message').text(error.responseJSON.message)
                $('.failure-message').show().delay(10000).fadeOut();
            }).always(function () {
                $('#modal-delete-order').modal('hide');
            });
        })
    </script>
}